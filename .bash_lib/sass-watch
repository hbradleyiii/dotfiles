#!/bin/bash
#
# name:             sass-watch
# author:           Harold Bradley III
# email:            harold@bradleystudio.net
# created:          Fri 15 July 2013 11:53:35 AM EST
#
# description:      Watches sass files for modifications and compiles them
#
#                   This script assumes the sass files are in a directory named
#                   sass either in the current directory, in the parent
#                   directory, or in the parent's parent directory.
#
#                   Settings can be modified by creating a bash file named
#                   sass.config that is in the sass directory.
#
#                   Settings:
#                       $SASS_FILE - the main sass file to compile
#                       $STYLE_SHEET - the location of the stylesheet to compile
#                       $FLAGS - any flags to pass to sassc
#

# compile() {{{1
#   compile sass
function compile() {
    local event_name=$1
    local filename=$2
    SASS_WATCH_ERROR_FLAG=0

    # Clear any previous errors
    if [[ $SASS_WATCH_ERROR_FLAG -ne 0 ]] ; then
        clear
        SASS_WATCH_ERROR_FLAG=0
    fi

    printf "\e[1;33m%-11s \e[m%-30s" "    $event_name " "$filename"
    TIMEFORMAT="(%Rs)"
    time (
        local error_msg="$(sassc $SASS_FILE $STYLE_SHEET $FLAGS 2>&1 > /dev/null)"

        if [[  $error_msg == "" ]] ; then
            printf "\e[0;32m[compiled]\e[m "
        else
            printf "\n\e[0;31m %s\e[m " "$error_msg"
            SASS_WATCH_ERROR_FLAG=1
        fi
    )
}
# }}}


# main() {{{1
#   main function
function main() {
    SASS_DIR="$(pwd)/sass"
    if [[ ! -d "$SASS_DIR" ]] ; then
        SASS_DIR=$(readlink -f "../sass")  # Using readlink to resolve relative path
        if [[ ! -d "$SASS_DIR" ]] ; then
            SASS_DIR=$(readlink -f "../../sass")  # Using readlink to resolve relative path
        fi
    fi
    SASS_FILE="$SASS_DIR/style.scss"
    STYLE_SHEET=$(readlink -f "$SASS_DIR/../css/style.css")  # Using readlink to resolve relative path
    FLAGS="-m"

    # Source sass.config if it exists
    if [[ -f "$SASS_DIR/sass.config" ]] ; then
        source "$SASS_DIR/sass.config"
    fi

    if [[ ! -d "$SASS_DIR" ]] ; then
        read -rsp "SASS directory not found. Press any key to continue...\n" -n1 key
    fi

    printf "        \e[0;32mRunning sass-watch \e[m \e[0;34m[sassc %s]\e[m\n" "$FLAGS"
    # First compile:
    compile "Starting: " "$(basename $STYLE_SHEET)"
    printf "\n\e[0;34m>>  Watching for changes...\e[m\n"

    local last_mod_time=0
    local last_file=""

    # Set up watches:
    inotifywait -qmr -e create,delete,modify,move --format "%f %e %T" --timefmt "%s" $SASS_DIR |
    while read filename event mod_time; do
        if [[ "${filename##*.}" == "scss" ]] ; then

            # Make sure at least 1 second has changed since last mod of this file
            if [[ $last_mod_time -ge $(($mod_time - 1)) ]] && [[ $last_file == $filename ]] ; then continue ; fi

            # Otherwise, save this modtime/filename and continue compiling:
            last_mod_time=$mod_time
            last_file=$filename

            # Set screen friendly event name
            case $event in
                'CREATE')
                    local event_name="Created:  "
                    ;;
                'DELETE')
                    local event_name="Deleted:  "
                    ;;
                'MOVE')
                    local event_name="Moved:    "
                    ;;
                'MODIFY')
                    local event_name="Modified: "
                    ;;
                *)
                    local event_name="Modified: "
                    ;;
            esac

            # Compile the sass
            compile "$event_name" "$filename"
        fi
    done
}
# }}}


    # Run sass-watch main function if called directly
if [[ $0 = */sass-watch ]] ; then
    main
fi

# vim:set ft=sh fdm=marker:
